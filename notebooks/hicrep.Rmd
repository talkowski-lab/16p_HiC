---
title: "HiCRep analysis of 16p samples"
author: "Siddharth Reed"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: true
        toc_float: true
        theme: paper
        code_folding: hide
        df_print: paged
---
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Prepare data

Set up file locations
```{r results='hide', echo=TRUE}
library(here)
BASE_DIR=here()
source(file.path(BASE_DIR, 'scripts/locations.R'))
```
Load dependencies
```{r}
library(tidyverse)
library(magrittr)
source(file.path(BASE_DIR, 'scripts/utils.data.R'))
source(file.path(BASE_DIR, 'scripts/utils.plot.R'))
source(file.path(BASE_DIR, 'scripts/utils.hicrep.R'))
library(ggplot2)
library(ggh4x)
library(purrr)
```
Load hicrep data
```{r results=FALSE, message=FALSE, warning=FALSE}
hicrep.results <- 
    check_cached_results( 
        HICREP_RESULTS_FILE,
        force_redo=FALSE,
        return_data=TRUE,
        results_fnc=load_all_hicrep_results
    )
```
Print sample rows
```{r rows.print=5}
hicrep.results %>% 
    arrange(resolution, h, is.downsampled, window.size, chr, SampleNumber)
```

# Summary Stats

How many different parameter combinations we tried
```{r rows.print=5}
hicrep.results %>%
    filter(chr == 'chr16') %>% 
    dplyr::count(!!!syms(c(HICREP_PARAM_NAMES, 'ReadFilter')))
```

How many different pairs of sample matrices were compared
```{r rows.print=5}
hicrep.results %>%
    filter(chr == 'chr16') %>% 
    dplyr::count(
        Genotype,
        SampleNumber,
        Celltype,
        Edit
    )
```

All sample pairs + conditions where HiCRep scores were calculated
```{r rows.print=5}
hicrep.results %>%
    dplyr::count(
        !!!syms(
            c(
                HICREP_PARAM_NAMES,
                'Genotype',
                'SampleNumber',
                'ReadFilter',
                'Celltype',
                'Edit'
            )
        )
    )
```

# Plot distributions of HiCRep scores {.tabset}

Prepare data for plotting
```{r prep_plot_df, include=FALSE}
plot.df <- 
    hicrep.results %>%
    mutate(resolution=as.integer(resolution)) %>% 
    rowwise() %>% 
    mutate(
        Genotype=
            case_when(
                grepl('vs', Genotype) ~ Genotype,
                TRUE ~ paste(Genotype, 'vs', Genotype, collapse=" ")
            )
    ) %>% 
    ungroup() %>% 
    mutate(chr=factor(chr, levels=CHROMOSOMES)) %>% 
    mutate(
        sample1.is.new=grepl('(G7|p46|H10) vs', SampleNumber),
        sample2.is.new=grepl('vs (G7|p46|H10)', SampleNumber),
        SampleNovelty=
            case_when(
                 sample1.is.new &  sample2.is.new ~ 'New vs New',
                 sample1.is.new & !sample2.is.new ~ 'New vs Old',
                !sample1.is.new &  sample2.is.new ~ 'New vs Old',
                !sample1.is.new & !sample2.is.new ~ 'Old vs Old',
                TRUE ~ 'error'
            )
    ) %>% 
    left_join(
        RESOLUTION_NAMES,
        by=join_by(resolution == Resolution)
    ) %>%
    select(-c(resolution)) %>% 
    rename(resolution=Resolution.name)
```

## Compare Differences between Genotypes

Boxplot of hicrep scores by various levels
```{r new_boxplot, echo=FALSE, fig.align='center', out.width='100%', fig.height=7}
plot.df %>% 
    plot_hicrep_boxplot(
        'Genotype',
        mark_chr16=TRUE,
        size=0.7
    )
```

## Plot first 6 processed samples only

Now plot individual sample pair distributions to see if the 3 new samples are less reproducible than the 6 original samples
```{r old_boxplot, echo=FALSE, fig.align='center', out.width='100%', fig.height=7}
plot.df %>% 
    filter(SampleNovelty == 'Old vs Old') %>% 
    plot_hicrep_boxplot(
        'Genotype',
        mark_chr16=TRUE,
        size=0.7
    )
```

## Compare Differences between New/Old samples

How many new vs old samples pairs being compared
```{r novel_table, rows.print=6}
plot.df %>% 
    filter(chr == 'chr16') %>% 
    group_by(
        resolution,
        h,
        is.downsampled,
        window.size,
        ReadFilter
    ) %>% 
    dplyr::count(SampleNovelty)
```
Now plot individual sample pair distributions to see if the 3 new samples are less reproducible than the 6 original samples
```{r novel_boxplot, echo=FALSE, fig.align='center', out.width='100%', fig.height=8}
plot.df %>% 
    plot_hicrep_boxplot(
        'SampleNovelty',
        mark_chr16=TRUE,
        size=0.7
    )
```

## HiCRep scores per chromosome 

See if there are any trends in HiCRep scores across chromosomes and if they are influenced by HiCRep params or samples genotype
```{r per_chr, results='asis', echo=FALSE, out.width='100%', fig.height=7}
resolution_boxplot_fnc <- function(plot.df){
    plot.df %>% 
    plot_hicrep_boxplot(
        'chr',
        facet_row='Genotype',
        facet_col='Celltype', 
        mark_chr16=FALSE,
        size=0.7
    ) + 
    geom_hline(yintercept=0.95, linetype='solid', linewidth=0.15) +
    theme(axis.text.x=element_text(angle=45, hjust=1))
}
plot.df %>%
    make_tab_per_group(
        group_col='resolution',
        col_header=FALSE,
        plot_fnc=resolution_boxplot_fnc
    )
```
