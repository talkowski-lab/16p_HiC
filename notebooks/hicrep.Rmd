---
title: "HiCRep analysis of 16p samples"
author: "Siddharth Reed"
date: "`r Sys.Date()`"
output: 
    html_document:
        keep_md: yes
        toc: true
        toc_float: true
        theme: paper
        code_folding: hide
        df_print: paged
---
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Dependencies 

```{r knitr}
library(knitr)
knitr::opts_chunk$set(
    dev=c('png', 'pdf', 'svg'),
    dpi=300
)
```
Set up file locations + load dependenies
```{r dependencies, results=FALSE, message=FALSE, warning=FALSE}
library(here)
here::i_am('notebooks/hicrep.Rmd')
BASE_DIR <- here()
SCRIPT_DIR <- here('scripts')
source(file.path(SCRIPT_DIR, 'locations.R'))
source(file.path(SCRIPT_DIR, 'constants.R'))
source(file.path(SCRIPT_DIR, 'utils.data.R'))
source(file.path(SCRIPT_DIR, 'utils.plot.R'))
source(file.path(SCRIPT_DIR, 'utils.hicrep.R'))
library(tidyverse)
library(magrittr)
library(ggplot2)
library(ggh4x)
library(purrr)
```

# Load HiCRep Results

Load sample metadata
```{r load_metadata, results=FALSE, message=FALSE, warning=FALSE}
sample.metadata <- 
    load_sample_metadata(filter=TRUE) %>%
    mutate(FlowcellID=factor(FlowcellID)) %>%
    mutate(Batch=factor(glue('Batch {as.integer(FlowcellID)}')))
```
Load hicrep data
```{r load_results, results=FALSE, message=FALSE, warning=FALSE}
hicrep.results <- 
    check_cached_results( 
        HICREP_RESULTS_FILE,
        # force_redo=TRUE,
        return_data=TRUE,
        results_fnc=load_all_hicrep_results,
        sample_metadata=
            sample.metadata %>% 
            select(
                SampleID,
                # Edit,
                # Celltype,
                # Genotype,
                # CloneID,
                # TechRepID,
                Batch
            )
    ) %>% 
    filter(isMerged != 'Individual vs Merged') %>%
    filter(ReadFilter == 'mapq_30 vs mapq_30') %>%
    # format numbers for easy reading
    mutate(
        across(
            c(resolution, window.size),
            scale_numbers
        )
    ) %>% 
    mutate(chr=factor(chr, levels=CHROMOSOMES)) %>% 
    # filter(!grepl('iN', Celltype)) %>% 
    select(-c(ReadFilter, filepath))
```
Print example data
```{r summary_stats, eval=FALSE}
hicrep.results %>% colnames()
hicrep.results %>% 
    distinct(SampleID) %>% 
    separate_wider_delim(SampleID, names=c('Sample1', 'Sample2'), delim=' vs ') %>%
    pivot_longer(c(Sample1, Sample2), names_to='tmp', values_to='sample') %>% 
    distinct(sample) %>% arrange(sample)
hicrep.results %>% 
    distinct(SampleID, resolution, window.size, is.downsampled) %>% 
    count(resolution, window.size, is.downsampled)
# plot.df <- hicrep.results
```
```{r example_results, rows.print=5, eval=FALSE}
# hicrep.results %>% filter(chr == 'chr1') %>% count(isMerged,Edit, Celltype, Genotype)
hicrep.results %>% 
    arrange(
        across(
            c(
                resolution,
                h,
                is.downsampled,
                window.size,
                chr, 
            )
        )
    )
```

# Compare results with different parameter combinations {.tabset}

How many different pairs of sample matrices were compared per batch
```{r n_samples, rows.print=5}
    # resolution,
    # h,
    # is.downsampled,
    # window.size,
    # # Edit,
    # Celltype,
    # Genotype,
    # # CloneID,
    # # TechRepID,
    # isMerged,
    # # SampleID,
    # Batch,
    # # hicrep.score,
    # # chr
hicrep.results %>%
        # count(resolution, window.size, is.downsampled, chr)
    filter(
        resolution == '10Kb',
        window.size == '5Mb',
        is.downsampled,
        chr == 'chr1'
    ) %>% 
    count(
        isMerged,
        Celltype,
        Batch,
        Genotype,
        name='n.sample.pairs'
    )
```

## Use all pairs of individual sample matrices

Compare values by hyper-param to showcase the variability
```{r hyperparam_boxplox, results='asis', echo=FALSE, out.width='100%', fig.height=7}
hicrep.results %>% 
    mutate(
        withinGenotype=
            case_when(
                Genotype %in% c('DEL vs DEL', 'DUP vs DUP', 'WT vs WT') ~ 'Same Genotype',
                TRUE ~ 'Different Genotype'
            )
    ) %>% 
    make_nested_plot_tabs(
        group_cols=c('isMerged', 'Celltype', 'withinGenotype'),
        max_header_lvl=3,
        plot_fnc=plot_hicrep_boxplot,
        sample_group='window.size',
        fill_var='is.downsampled', 
        facet_col='resolution',
        facet_row='Batch'
    )
```

## Pick specific parameter set for downstream analyses

Pick a specific set of parameters to plto results for later
```{r pick_param_set}
plot.df <- 
    hicrep.results %>% 
    filter(
        is.downsampled,
        window.size == '5Mb'
        # resolution == '25Kb'
        # h == Ideal_H,
    )
plot.df %>% distinct(h, window.size, resolution, is.downsampled)
```

# Plotting HiCRep scores {.tabset}

## Compare Scores across genotype comparisons

Plot score distributions between Genotypes
```{r compare_scores, results='asis'}
plot.df %>% 
    # filter(Genotype %in% c('DEL vs DEL', 'DUP vs DUP', 'WT vs WT')) %>% 
    make_nested_plot_tabs(
        group_cols=c('isMerged'),
        max_header_lvl=3,
        plot_fnc=plot_hicrep_boxplot,
        sample_group='Genotype',
        fill_var='is.downsampled', 
        facet_col='resolution',
        facet_row='Celltype'
    )
```

## HiCRep scores per chromosome 

```{r per_chr, results='asis', fig.height=6}
plot.df %>% 
    make_nested_plot_tabs(
        group_cols=c('isMerged', 'resolution', 'Celltype'),
        max_header_lvl=3,
        plot_fnc=plot_hicrep_boxplot,
        fill_var=NA,
        sample_group='chr',
        facet_col='Genotype'
    )
```
