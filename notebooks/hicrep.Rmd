---
title: "HiCRep analysis of 16p samples"
author: "Siddharth Reed"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: true
        toc_float: true
        theme: paper
        code_folding: hide
        df_print: paged
---
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Prepare data

Set up file locations
```{r results='hide', echo=TRUE}
library(here)
BASE_DIR=here()
source(file.path(BASE_DIR, 'scripts/locations.R'))
```
Load dependencies
```{r}
library(tidyverse)
library(magrittr)
source(file.path(BASE_DIR, 'scripts/utils.data.R'))
source(file.path(BASE_DIR, 'scripts/utils.plot.R'))
source(file.path(BASE_DIR, 'scripts/utils.hicrep.R'))
library(ggplot2)
library(ggh4x)
```
Load hicrep data
```{r results=FALSE, message=FALSE, warning=FALSE}
hicrep.results <- 
    check_cached_results( 
        HICREP_RESULTS_FILE,
        force_redo=FALSE,
        return_data=TRUE,
        results_fnc=load_all_hicrep_results
    )
```

Print sample rows
```{r rows.print=5}
hicrep.results %>% 
    arrange(resolution, h, is.downsampled, window.size, chr, SampleNumber)
```

# Summary Stats

How many different parameter combinations we tried
```{r rows.print=5}
hicrep.results %>%
    filter(chr == 'chr16') %>% 
    dplyr::count(!!!syms(HICREP_PARAM_NAMES))
```

How many different pairs of sample matrices were compared
```{r rows.print=5}
hicrep.results %>%
    filter(chr == 'chr16') %>% 
    dplyr::count(
        Edit,
        Genotype,
        Celltype,
        SampleNumber,
        ReadFilter
    )
```

# Plot distributions of HiCRep scores 

```{r include=FALSE}
```{r prep_plot_df, include=FALSE}
plot.df <- 
    hicrep.results %>%
    mutate(resolution=as.integer(resolution)) %>% 
    rowwise() %>% 
    mutate(
        Genotype=
            case_when(
                grepl('vs', Genotype) ~ Genotype,
                TRUE ~ paste(Genotype, 'vs', Genotype, collapse=" ")
            )
    ) %>% 
    ungroup() %>% 
    mutate(
        sample1.is.new=grepl('(G7|p46|H10) vs', SampleNumber),
        sample2.is.new=grepl('vs (G7|p46|H10)', SampleNumber),
        SampleNovelty=
            case_when(
                sample1.is.new & sample2.is.new ~ 'both.new',
                sample1.is.new & !sample2.is.new ~ 'one.new',
                !sample1.is.new & sample2.is.new ~ 'one.new',
                !sample1.is.new & !sample2.is.new ~ 'both.old',
                TRUE ~ 'error'
            )
    ) %>% 
    left_join(
        RESOLUTION_NAMES,
        by=join_by(resolution == Resolution)
    ) %>%
    select(-c(resolution)) %>% 
    rename(resolution=Resolution.name)
```

Boxplot of hicrep scores by various levels
```{r new_boxplot, echo=FALSE, fig.align='center', out.width='100%', fig.height=7}
plot.df %>% 
    plot_hicrep_boxplot(
        'Genotype',
        mark_chr16=TRUE,
        size=0.7
    )
```

plot.df %>% 
    plot_hicrep_boxplot(
        'Genotype',
        mark_chr16=TRUE,
        size=0.7
    )
```

Now plot individual sample pair distributions to see if the 3 new samples are less reproducible than the 6 original samples
```{r echo=FALSE, fig.align='center', out.width='100%', fig.height=8}
plot.df %>% 
ggplot(
    aes(
        x=SampleNovelty,
        y=hicrep.score,
        fill=is.downsampled,
        color=ReadFilter
    )
) +
geom_boxplot(outlier.size=0.5) +
facet_grid2(
    rows=vars(resolution),
    cols=vars(Celltype),
    scales='fixed'
) +
theme(legend.position='top') +
add_ggtheme()
```
