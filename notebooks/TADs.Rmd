---
title: "TAD Analysis for 16p"
author: "Siddharth Reed"
date: "`r Sys.Date()`"
output: 
    html_document:
        keep_md: yes
        toc: true
        toc_float: true
        theme: paper
        code_folding: hide
        df_print: paged
---
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Set Up

```{r knitr}
library(knitr)
knitr::opts_chunk$set(
    dev=c('png', 'pdf', 'svg'),
    dpi=300
)
```
Set up file locations + load dependences
```{r file_locs, results=FALSE, message=FALSE, warning=FALSE}
library(here)
here::i_am('notebooks/TADs.Rmd')
BASE_DIR <- here()
source(file.path(here(), 'scripts', 'locations.R'))
source(file.path(SCRIPT_DIR, 'constants.R'))
source(file.path(SCRIPT_DIR, 'utils.data.R'))
source(file.path(SCRIPT_DIR, 'utils.plot.R'))
source(file.path(SCRIPT_DIR, 'utils.TADs.R'))
library(tidyverse)
library(magrittr)
library(ggplot2)
library(ggh4x)
library(purrr)
```

# hiTAD TAD annotations {.tabset}

Load all hiTAD annotations
```{r load_hiTAD_TADs}
sample.metadata <- load_sample_metadata()
all.hitad.annotations <- 
    check_cached_results(
        results_file=TAD_RESULTS_FILE,
        results_fnc=load_all_TAD_annotations,
        # force_redo=TRUE,
        pattern='/method_hiTAD/'
    ) %>% 
    inner_join(
        sample.metadata %>% select(SampleID),
        by=join_by(SampleID)
    ) %>% 
    mutate(
        isMerged=factor(ifelse(isMerged, 'Merged', 'Individual')),
        resolution=scale_numbers(resolution),
        chr=factor(chr, levels=CHROMOSOMES),
        TAD.length=TAD.end - TAD.start
    ) %>% 
    select(
        isMerged,
        Edit,
        Genotype,
        Celltype,
        CloneID,
        TechRepID,
        SampleID,
        resolution,
        weight,
        chr,
        TAD.start,
        TAD.end,
        TAD.length
    )
# Subset to only relevant parameters
hitad.annotations <- 
    all.hitad.annotations %>% 
    filter(weight == 'ICE')
```

    )
```

# cooltools Boundary Annotations

## Load cooltools annotations

- Calling Parameters
  - resolution
  - weight
  - threshold
  - mfvp
  - window.size
- Individual TAD data
  - chr
  - TAD.start
  - TAD.end
  - n_valid_pixels
  - boundary_strength
```{r load_cooltools_TADs, eval=FALSE}
# tad.annotations %>% colnames()
# tad.annotations %>% filter(region != chr)
# Cooltools annotations
all.cooltools.annotations <- 
    tad.annotations %>%
    filter(method == 'cooltools') %>% 
    rename('TAD.boundary'=TAD.start) %>% 
    mutate(
        window.size.bins=window.size / resolution,
        window.size=scale_numbers(window.size),
        resolution=scale_numbers(resolution)
    ) %>% 
    select(-c(TAD.end, window.size, method))
    # filter(ReadFilter == 'mapq_30') %>% 
    # select(-c(ReadFilter, region, is_boundary)) %>% 
    get_info_from_SampleIDs(
        sample_ID_col='SampleID',
        keep_id=TRUE,
        nest_col=NA
    )
# Filter tads to relevant parameter set
cooltools.annotations <- 
    all.cooltools.annotations %>%
    filter(
        weight == 'ICE',
        mfvp == 0.9,
        window.size.bins == 60,
        threshold == 'Li'
    )
```

## cooltools parameter variability

Now plot number of TADs/boundaries 
```{r PLOT_cooltools_tad_number, results='asis', fig.width=8, fig.height=6, eval=FALSE}
cooltools.annotations %>% 
    mutate(resolution=scale_numbers(resolution)) %>% 
    group_by(isMerged, resolution, Sample.ID, chr) %>% 
    dplyr::count(name='nBoundaries') %>% 
    make_nested_plot_tabs(
        group_cols=c('isMerged'),
        max_header_lvl=3,
        plot_fnc=plot_heatmap,
        x_var='chr',
        y_var='Sample.ID',
        fill_var='nBoundaries',
        facet_row='resolution',
        scales='fixed'
    )
    # group_by(isMerged) %>%
    # group_map(
    #     ~ plot_heatmap(
    #         plot.df=.x,
    #         x_var='chr',
    #         y_var='Sample.ID',
    #         fill_var='nBoundaries',
    #         facet_row='resolution',
    #         scales='fixed'
    #     )
    # ) %>% 
    # cowplot::plot_grid(
    #     plotlist=.,
    #     align='v',
    #     ncol=1
    # ) %>% 
    # ggsave(
    #     file.path(PLOT_DIR, 'cooltools.nBoundariess.heatmap.pdf'),
    #     .,
    #     width=10,
    #     height=10,
    #     units='in'
    # )
```
Plot tads for hitads
```{r PLOT_hitad_tad_number, results='asis', fig.width=8, fig.height=6}
hitad.annotations %>% 
    mutate(resolution=scale_numbers(resolution)) %>% 
    group_by(isMerged, resolution, Sample.ID, chr) %>% 
    dplyr::count(name='nTADs') %>% 
    make_nested_plot_tabs(
        group_cols=c('isMerged'),
        max_header_lvl=3,
        plot_fnc=plot_heatmap,
        x_var='chr',
        y_var='Sample.ID',
        fill_var='nTADs',
        facet_row='resolution',
        scales='fixed'
    )
    # group_by(isMerged) %>%
    # group_map(
    #     ~ plot_heatmap(
    #         plot.df=.x,
    #         x_var='chr',
    #         y_var='Sample.ID',
    #         fill_var='nTADs',
    #         facet_row='resolution',
    #         scales='fixed'
    #     )
    # ) %>% 
    # cowplot::plot_grid(
    #     plotlist=.,
    #     align='v',
    #     ncol=1
    # ) %>% 
    # ggsave(
    #     file.path(PLOT_DIR, 'HiTAD.nTADs.pdf'),
    #     .,
    #     width=10,
    #     height=10,
    #     units='in'
    # )
```
Plot TAD lengths
```{r PLOT_hitad_tad_length, results='asis', fig.width=8, fig.height=6}
# hitad.annotations %>% group_by(isMerged, Genotype, chr,  resolution) %>% slice_head(n=5) %>% select(TAD.length)
hitad.annotations %>% 
    mutate(resolution=scale_numbers(resolution)) %>% 
    make_nested_plot_tabs(
        group_cols=c('isMerged'),
        max_header_lvl=3,
        plot_fnc=plot_boxplot,
        x_var='chr',
        y_var='TAD.length',
        fill_var='Genotype',
        facet_row='resolution',
        scales='free_y',
        scale_mode='mb',
        y_accuracy=0.1
    )
    # group_by(isMerged) %>%
    # group_map(
    #     ~ plot_boxplot(
    #         plot.df=.x,
    #         x_var='chr',
    #         y_var='TAD.length',
    #         fill_var='Genotype',
    #         # fill_var='nTADs',
    #         facet_row='resolution',
    #         scales='free_y'
    #     )
    # ) %>% 
    # lapply(
    #     scale_y_axis,
    #     mode='mb',
    #     axis_label_accuracy=0.1
    # ) %>% 
    # cowplot::plot_grid(
    #     plotlist=.,
    #     align='v',
    #     ncol=1
    # ) %>% 
    # ggsave(
    #     file.path(PLOT_DIR, 'HiTAD.TAD.length.pdf'),
    #     .,
    #     width=10,
    #     height=10,
    #     units='in'
    # )
```

# TAD Similarity

Calculate MoC for all pairs of TAD annotation sets
```{r calculate_mocs}
hitad.mocs <- 
    check_cached_results(
        results_file=TAD_MOC_FILE,
        force_redo=FALSE,
        return_data=TRUE,
        show_col_types=FALSE,
        results_fnc=
            function(hitad.annotations){
                hitad.annotations %>% 
                select(-c(group_col)) %>% 
                nest(
                    SampleInfo=
                        c(
                            Edit,
                            Genotype,
                            SampleNumber,
                            Celltype
                        )
                ) %>%
                nest(
                    TADs=
                        c(
                            TAD.start,
                            TAD.end,
                            TAD.length
                        )
                ) %>%
                calculate_all_pairs_MoCs(
                    pair_grouping_cols=
                        c(
                            'resolution',
                            'isMerged',
                            'weight',
                            'chr'
                        )
                )
            },
        hitad.annotations=hitad.annotations
    ) %>%
    mutate(
        resolution=scale_numbers(resolution),
        chr=factor(chr, levels=CHROMOSOMES),
        isMerged=ifelse(grepl('Merged', SampleNumber), 'Merged', 'Individual')
    )
hitad.mocs
```
Plot distribution of similarity between genotype pairs 
```{r plot_MoCs_boxplot, results='as.is'}
hitad.mocs %>% 
    rename('Measure.of.Concordance'=mocs) %>% 
    make_nested_plot_tabs(
        group_cols=c('isMerged'),
        max_header_lvl=3,
        plot_fnc=plot_boxplot,
        x_var='Genotype',
        y_var='Measure.of.Concordance',
        facet_row='resolution',
        scales='fixed'
    )
    # group_by(isMerged) %>%
    # group_map(
    #     ~ plot_boxplot(
    #         plot.df=.x,
    #         x_var='Genotype',
    #         y_var='Measure.of.Concordance',
    #         facet_row='resolution',
    #         scales='fixed'
    #     )
    # ) %>% 
    # cowplot::plot_grid(
    #     plotlist=.,
    #     align='v',
    #     ncol=1
    # ) %>% 
    # ggsave(
    #     file.path(PLOT_DIR, 'HiTAD.TAD.MoCs.boxplot.pdf'),
    #     .,
    #     width=10,
    #     height=10,
    #     units='in'
    # )
```
Plot mean similarity between genotype pairs per chromosome
```{r plot_MoCs_heatmap, results='as.is'}
hitad.mocs %>% 
    rename('Measure.of.Concordance'=mocs) %>% 
    group_by(weight, resolution, isMerged, chr, Genotype) %>%
    summarize(mean.MoC=mean(Measure.of.Concordance)) %>% 
    make_nested_plot_tabs(
        group_cols=c('isMerged'),
        max_header_lvl=3,
        plot_fnc=plot_heatmap,
        x_var='chr',
        y_var='Genotype',
        fill_var='mean.MoC',
        facet_row='resolution',
        scales='fixed'
    )
    # group_by(isMerged) %>%
    # group_map(
    #     ~ plot_heatmap(
    #         plot.df=.x,
    #         x_var='chr',
    #         y_var='Genotype',
    #         fill_var='mean.MoC',
    #         facet_row='resolution',
    #         scales='fixed'
    #     )
    # ) %>% 
    # cowplot::plot_grid(
    #     plotlist=.,
    #     align='v',
    #     ncol=1
    # )
    # ) %>% 
    # ggsave(
    #     file.path(PLOT_DIR, 'HiTAD.TAD.MoCs.heatmap.pdf'),
    #     .,
    #     width=10,
    #     height=10,
    #     units='in'
    # )
```

# Load Directionality Index scores

```{r load_DI, eval=FALSE}
DI.scores <- 
    load_all_TAD_annotations(
        tad_annotations_dir=glue('{BASE_DIR}/results/TADs/hiTAD'),
        tad.method='hiTAD-DIs',
        file_suffix='-DIs.txt',
        param_names=
            c(
                'Normalization',
                'Resolution',
                'SampleName'
            ),
    ) %>%
    separate_wider_delim(
        SampleName,
        delim=fixed('.'),
        names=
            c(
                'SampleName',
                NA,
                'ReadFilter',
                NA
            )
    ) %>% 
    mutate(
        Resolution=as.integer(Resolution),
        chr=factor(chr, levels=CHROMOSOMES)
    ) 
DI.scores %>% head(2) %>% t()
```

# Plot DI Scores

```{r plot_DI, eval=FALSE}
tmp <- 
    DI.scores %>%
    add_count(Resolution, SampleName, chr, name='n.bins') %>% 
    left_join(
        tad.annotations %>% select(c(Resolution, SampleName, chr, TAD.start, TAD.end)),
        by=
            join_by(
                Resolution,
                chr,
                SampleName,
                between(bin.start, TAD.start, TAD.end, bounds='[)')
            ) 
    ) %>%
    mutate(
        TAD.boundaries=
            case_when(
                bin.start == TAD.start ~ 'TAD.Start',
                bin.end == TAD.end ~ 'TAD.End',
                bin.start >= TAD.start & bin.end <= TAD.end ~ 'TAD.inner',
                TRUE ~ 'Non-TAD'
        )
    )
tmp %>% 
    # filter(chr %in% paste0('chr', c(1,3,5,10,16,20,'X'))) %>% 
    filter(chr == 'chr16') %>% 
    mutate(Resolution=glue('{Resolution / 1000}Kb')) %>%
    mutate(Resolution=factor(Resolution, levels=c('100Kb', '50Kb', '10Kb', '5Kb'))) %>% 
    group_by(Method) %>%
    group_map(
        ~ ggplot(
            .x, 
            aes(
                x=bin.start,
                y=DI,
                group=chr,
                color=Genotype
                # color=Genotype, shape=Replicate
            )
        ) +
        # geom_rect(data=.x %>% filter(SampleName == ''), aes(xmin=TAD.start, xmax=TAD.end, ymin=-Inf, ymax=0, fill=SampleName), alpha=0.01, size=0) +
        geom_line() +
        labs(x='bins', y='Directionality Index') +
        ggh4x::facet_grid2(cols=vars(chr), rows=vars(Resolution), scales='free_y') +
        scale_x_continuous(
            n.breaks=10,
            expand=c(0.01, 0.01, 0.01, 0.01),
            limits=c(0, NA)
        ) +
        theme(
            legend.position='top',
            axis.title.x=element_blank(),
            axis.text.x=element_text(angle=45, hjust=1),
            axis.text.y=element_markdown()
        ) +
        add_ggtheme(),
        .keep=TRUE
    ) %>% 
    cowplot::plot_grid(
        plotlist=.,
        align='v',
        ncol=1
    )
```

# Scratch

```{r print_stuff, eval=FALSE}
cooltools.annotations
cooltools.annotations %>% colnames()
hitad.annotations %>% colnames()
hitad.annotations
hitad.mocs
```

