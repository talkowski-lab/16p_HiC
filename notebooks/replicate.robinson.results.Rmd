---
title: "Replicate Reuslts from Weiner et al. 2022"
author: "Siddharth Reed"
date: "`r Sys.Date()`"
output: 
    html_document:
        keep_md: yes
        toc: true
        toc_float: true
        theme: paper
        code_folding: hide
        df_print: paged
---
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Prepare data

```{r knitr}
library(knitr)
knitr::opts_chunk$set(
    dev=c('png', 'pdf', 'tiff'),
    dpi=300
)
```
Set up file locations
```{r locations, results=FALSE}
library(here)
BASE_DIR=here()
source(file.path(BASE_DIR, 'scripts/locations.R'))
```
Load dependencies
```{r deps}
library(tidyverse)
library(magrittr)
source(file.path(BASE_DIR, 'scripts/utils.data.R'))
source(file.path(BASE_DIR, 'scripts/utils.plot.R'))
source(file.path(BASE_DIR, 'scripts/utils.robinson.R'))
```
Load sample metadata
```{r load_metadata, message=FALSE, rows.print=5}
RESOLUTION <- 100000  # used in the original paper
sample.metadata <- 
    load_sample_metadata() %>%
    select(-c(Sample.Name)) %>%
    filter(Celltype == 'NSC')
sample.metadata
```
Load contact matrices for each file
```{r load_contacts, rows.print=5}
contacts.df <- 
    load_mcool_files(
        pattern='*.NSC.*.mapq_30.1000.mcool',
        range1s='chr16',
        resolutions=c(RESOLUTION),
    ) %>%
    mutate(is.Merged=grepl('Merged', Sample.ID)) %>%
    separate_wider_delim(
        Sample.ID,
        delim=fixed('.'),
        cols_remove=FALSE,
        names=c(
            'Edit',
            'Genotype',
            'SampleNumber',
            'Celltype'
        )
    )
```

# Plot IFs of ELISE vs CTRL regions 

Prepare data for plotting, count how many bin-pairs there are per annotated category
```{r plot_df, rows.print=50}
# Annotate all regions each for each bin and bin-pair (contacts, 1 per row)
plot.df <- 
    check_cached_results(
        results_file=ROBINSON_REPLICATION_DATA_FILE,
        force_redo=FALSE,
        return_data=TRUE,
        show_col_types=FALSE,
        results_fnc=annotate_contact_regions,
        contacts.df=contacts.df,
        regions.of.interest=
            GENOMIC_REGIONS %>%
            filter(
                region %in% c(
                    "chr16p.deletion",
                    "chr16p.telomere",
                    "chr16p",
                    "chr16q"
                )
            ),
        most_specific_only=TRUE
    ) %>%
    select(
        -c(
            ReadFilter,
            resolution,
            weight
        )
    )
plot.df %>% dplyr::count(Sample.ID, region)
```

## Weiner et al. 2022 replication {.tabset}

Here I just recreate the figure+results as simply as possible

### Individual Samples

```{r basic_individual, message=FALSE, fig.height=7, fig.width=7} 
plot.df %>% 
    filter(ReplicateNum != 'Merged') %>% 
    filter(
        region.title %in% c(
            '16p.Distance-matched control',
            '16p11.2 CNV - Telomere'
        )
    ) %>% 
    plot_contacts_regions_boxplot(
        bin_col='region.title',
        count_col='IF',
        color_col='region.color',
        facet_row='ReplicateNum',
        facet_col='Genotype',
        n_pos=0,
        n_size=2.5,
        test_offset_y=7,
        expansion=c(0.05, 0.01, 0.1, 0.01),
    )
```

### Merged Samples

```{r basic_merged, message=FALSE, fig.height=4, fig.width=6} 
plot.df %>% 
    filter(ReplicateNum == 'Merged') %>% 
    filter(
        region.title %in% c(
            '16p.Distance-matched control',
            '16p11.2 CNV - Telomere'
        )
    ) %>% 
    plot_contacts_regions_boxplot(
        bin_col='region.title',
        count_col='IF',
        color_col='region.color',
        facet_row='ReplicateNum',
        facet_col='Genotype',
        n_size=3,
        test_offset_y=4,
        expansion=c(0.05, 0.01, 0.1, 0.01),
    )
```

## Include more regions {.tabset}

We have more data so we can visualize some other relevant comparisons for this CNV region and use corrected p-values.

### Individual

```{r extra_regions_individual, message=FALSE, fig.width=11, fig.height=11} 
plot.df %>% 
    filter(ReplicateNum != 'Merged') %>% 
    filter(
        region.title %in% c(
            '16p11.2 CNV - Telomere',
            '16p.Distance-matched control',
            '16p-q.Distance-matched control',
            '16q.Distance-matched control',
            '16p11.2 CNV - 16p.Distance-matched control',
            '16p11.2 CNV - 16q.Distance-matched control',
            'Telomere - 16p.Distance-matched control'
        )
    ) %>% 
    plot_contacts_regions_boxplot(
        bin_col='region.title',
        count_col='IF',
        color_col='region.color',
        facet_row='ReplicateNum',
        facet_col='Genotype',
        p.adjust.method='BH',
        p.max=0.05,
        tip.length=0,
        test_offset_y=3
    )
```

### Merged

```{r extra_regions_merged, message=FALSE, fig.width=12, fig.height=8} 
plot.df %>% 
    filter(ReplicateNum == 'Merged') %>% 
    filter(
        region.title %in% c(
            '16p11.2 CNV - Telomere',
            '16p.Distance-matched control',
            '16p-q.Distance-matched control',
            '16q.Distance-matched control',
            '16p11.2 CNV - 16p.Distance-matched control',
            '16p11.2 CNV - 16q.Distance-matched control',
            'Telomere - 16p.Distance-matched control'
        )
    ) %>% 
    plot_contacts_regions_boxplot(
        bin_col='region.title',
        count_col='IF',
        color_col='region.color',
        facet_row='ReplicateNum',
        facet_col='Genotype',
        p.adjust.method='BH',
        p.max=0.05,
        tip.length=0,
        test_offset_y=3
    )
```
