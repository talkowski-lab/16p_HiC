---
title: "Replicate Reuslts from Weiner et al. 2022"
author: "Siddharth Reed"
date: "`r Sys.Date()`"
output: 
    html_document:
        keep_md: yes
        toc: true
        toc_float: true
        theme: paper
        code_folding: hide
        df_print: paged
---
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Prepare data

```{r knitr}
library(knitr)
knitr::opts_chunk$set(
    dev=c('png', 'pdf', 'tiff'),
    dpi=300
)
```
Set up file locations + load dependenies
```{r file_locs, results=FALSE, message=FALSE, warning=FALSE}
library(here)
here::i_am('notebooks/replicate.robinson.results.Rmd')
BASE_DIR <- here()
SCRIPT_DIR <- here('scripts')
source(file.path(SCRIPT_DIR, 'locations.R'))
source(file.path(SCRIPT_DIR, 'constants.R'))
source(file.path(SCRIPT_DIR, 'utils.data.R'))
source(file.path(SCRIPT_DIR, 'utils.plot.R'))
source(file.path(SCRIPT_DIR, 'utils.robinson.R'))
library(tidyverse)
library(magrittr)
library(ggplot2)
library(ggh4x)
library(purrr)
```
Load contact matrices for each file + Annotate region-pair of interest for each bin-pair (contacts, 1 per row)
```{r load_contacts, rows.print=5}
# regions to annotate and compare
RESOLUTION <- 100000  # used in the original paper
regions.of.interest <- 
    GENOMIC_REGIONS %>%
    filter(
        region %in% c(
            "chr16p.deletion",
            "chr16p.telomere",
            "chr16p",
            "chr16q"
        )
    )
annotated.contacts.df <- 
    check_cached_results(
        results_file=ROBINSON_REPLICATION_DATA_FILE,
        force_redo=FALSE,
        return_data=TRUE,
        show_col_types=FALSE,
        results_fnc=load_annotated_contacts,
        regions.of.interest=regions.of.interest,
        pattern='*.NSC.*.mapq_30.1000.mcool',
        range1s='chr16',
        resolutions=c(RESOLUTION)
    )
annotated.contacts.df
```

# Plot IFs of Deleted CNV vs Controls regions 

Now we replicate the results in [Fig.4C from Weiner et al. 2022](https://www.nature.com/articles/s41588-022-01203-y#Fig4).
Specifically we want to comapre if contacts between the chr16p CNV region and the chr16 telomere are statistically more frequent than between any other regions on chr16p.

These regions are defined as follows
```{r regions, rows.print=50}
regions.of.interest %>%
    mutate(region.dist=scale_numbers(region.dist)) %>% 
    select(c(region, region.chr, region.start, region.end, region.dist, region.UCSC)) %>%
    rename(
        'Region'=region,
        'Chr'=region.chr,
        'Start Pos'=region.start,
        'End Pos'=region.end,
        'Size'=region.dist,
        'UCSC'=region.UCSC
    ) %>% 
    kable()
```
We also only compare distance-matched contacts to the CNV-telomere contacts of interest, using the following distance range of those CNV-telomere contacts
```{r distance_range}
# Boundaries of regions to compare
telomere.start <- 
    {regions.of.interest %>% filter(region == 'chr16p.telomere') %>% pull(region.start)}
telomere.end <- 
    {regions.of.interest %>% filter(region == 'chr16p.telomere') %>% pull(region.end)}
deletion.start <- 
    {regions.of.interest %>% filter(region == 'chr16p.deletion') %>% pull(region.start)}
deletion.end <- 
    {regions.of.interest %>% filter(region == 'chr16p.deletion') %>% pull(region.end)}
# Distance ranges to compare
dist.min <- 
    round(
        deletion.start - telomere.end,
        digits=-5 # round to nearest 100Kb bin
    )
dist.max <- 
    round(
        deletion.end - telomere.start,
        digits=-5 # round to nearest 100Kb bin
    )
# print
glue("Telomere region is between {telomere.start}-{telomere.end}")
glue("Deletion region is between {deletion.start}-{deletion.end}")
glue("All control contacts used are between {dist.min}bp and {dist.max}bp apart") %>% message()
```

How many bin-pairs there are in each annotated region
```{r plot_df, rows.print=7}
# Map colors and titles to each region of contacts
colors.and.titles <- 
    tribble(
        ~region, ~region.title, ~region.color,
        'chr16p.deletion vs chr16p.telomere', '16p11.2 CNV - Telomere',                     '#526ab1',
        'chr16p vs chr16p',                   '16p.Distance-matched control',               '#e32528',
        'chr16q vs chr16q',                   '16q.Distance-matched control',               '#5a0c10',
        'chr16p vs chr16q',                   '16p-q.Distance-matched control',             '#9e1517',
        'chr16p.deletion vs chr16p',          '16p11.2 CNV - 16p.Distance-matched control', '#8000ff',
        'chr16p.deletion vs chr16q',          '16p11.2 CNV - 16q.Distance-matched control', '#bf80ff',
        'chr16p.telomere vs chr16p',          'Telomere - 16p.Distance-matched control',    '#330066'
    ) %>% 
    mutate(region.title=factor(region.title))
# Keep only distance matched control bin-pairs and specify names+colors
plot.df <- 
    annotated.contacts.df %>% 
    select(
        -c(
            ReadFilter,
            resolution,
            weight
        )
    ) %>%
    # Filter for relevant contacts
    mutate(contact.dist=range2 - range1) %>% 
    filter(
        contact.dist > dist.min,
        contact.dist < dist.max
    ) %>% 
    # Number samples for faceting plots
    nest(
        data=
            -c(
                Edit,
                Celltype,
                Genotype,
                is.Merged, 
                Sample.ID
            )
    ) %>% 
    arrange(
        is.Merged,
        Genotype
    ) %>% 
    group_by(
        Edit,
        Celltype,
        Genotype
    ) %>% 
    mutate(ReplicateNum=as.character(row_number())) %>%
    ungroup() %>% 
    mutate(
        ReplicateNum=
            ifelse(
                grepl('Merged', Sample.ID),
                'Merged',
                glue('Bio Replicate {ReplicateNum}')
            )
    ) %>% 
    unnest(data) %>% 
    # Plot visual details
    left_join(
        colors.and.titles,
        by='region'
    ) %>% 
    mutate(
        region.color=
            ifelse(
                is.na(region.color),
                '#808080', 
                region.color
            ),
        Genotype=
            factor(
                Genotype,
                levels=
                    c(
                        'WT',
                        'DEL',
                        'DUP'
                    )
            )
    ) %>% 
    # Now produce results with different minimum IF thresholds
    lapply(
        0:5,
        function(threshold, df) {
            df %>% 
            filter(IF > threshold) %>% 
            add_column(IF.Threshold=glue('IF > {threshold}'))
        },
       df=. 
    ) %>%
    bind_rows()
plot.df %>% dplyr::count(IF.Threshold, Sample.ID, region.title)
```

```{r manual_check_regions, eval=FALSE}
plot.df %>% 
    filter(region.title %in% c('16p.Distance-matched control', '16p11.2 CNV - Telomere')) %>% 
    group_by(Sample.ID, IF.Threshold, region) %>%
    mutate(group=cur_group_id()) %>%
    ungroup() %>%
    filter(group == 2) %>% 
    count(range1, range2) %>% print(n=Inf)
```

## Weiner et al. 2022 replication {.tabset}

Here I just recreate the figure+results as simply as possible

### Individual Samples

```{r basic_individual, results='asis', message=FALSE, fig.height=7, fig.width=8} 
plot.df %>% 
    filter(ReplicateNum != 'Merged') %>% 
    filter(
        region.title %in% c(
            '16p.Distance-matched control',
            '16p11.2 CNV - Telomere'
        )
    ) %>% 
    make_nested_plot_tabs(
        group_cols=c('IF.Threshold', 'Celltype'),
        max_header_lvl=4,
        plot_fnc=plot_contacts_regions_boxplot,
        bin_col='region.title',
        count_col='IF',
        color_col='region.color',
        facet_row='ReplicateNum',
        facet_col='Genotype',
        n_pos=0,
        n_size=2.5,
        test_offset_y=7,
        expansion=c(0.05, 0.01, 0.1, 0.01),
        plot.margin=margin(0.05, 0.05, 0.05, 0.5, "in")
    )
```

### Merged Samples

```{r basic_merged, results='asis', message=FALSE, fig.height=5, fig.width=7} 
plot.df %>% 
    filter(ReplicateNum == 'Merged') %>% 
    filter(
        region.title %in% c(
            '16p.Distance-matched control',
            '16p11.2 CNV - Telomere'
        )
    ) %>% 
    make_nested_plot_tabs(
        group_cols=c('IF.Threshold', 'Celltype'),
        max_header_lvl=4,
        plot_fnc=plot_contacts_regions_boxplot,
        bin_col='region.title',
        count_col='IF',
        color_col='region.color',
        facet_row='ReplicateNum',
        facet_col='Genotype',
        tip.length=0,
        n_size=3,
        test_offset_y=4,
        expansion=c(0.05, 0.01, 0.1, 0.01),
        plot.margin=margin(0.05, 0.05, 0.05, 0.6, "in")
    )
```

## Include more regions {.tabset}

We have more data so we can visualize some other relevant comparisons for this CNV region and use corrected p-values.

### Individual

```{r extra_regions_individual, results='asis', message=FALSE, fig.width=11, fig.height=11, eval=FALSE} 
plot.df %>% 
    filter(ReplicateNum != 'Merged') %>% 
    filter(
        region.title %in% c(
            '16p11.2 CNV - Telomere',
            '16p.Distance-matched control',
            '16p-q.Distance-matched control',
            '16q.Distance-matched control',
            '16p11.2 CNV - 16p.Distance-matched control',
            '16p11.2 CNV - 16q.Distance-matched control',
            'Telomere - 16p.Distance-matched control'
        )
    ) %>% 
    plot_contacts_regions_boxplot(
        bin_col='region.title',
        count_col='IF',
        color_col='region.color',
        facet_row='ReplicateNum',
        facet_col='Genotype',
        p.adjust.method='BH',
        p.max=0.05,
        tip.length=0,
        test_offset_y=3
    )
```

### Merged

```{r extra_regions_merged, results='asis', message=FALSE, fig.width=14, fig.height=8, eval=FALSE} 
plot.df %>% 
    filter(ReplicateNum == 'Merged') %>% 
    filter(
        region.title %in% c(
            '16p11.2 CNV - Telomere',
            '16p.Distance-matched control',
            '16p-q.Distance-matched control',
            '16q.Distance-matched control',
            '16p11.2 CNV - 16p.Distance-matched control',
            '16p11.2 CNV - 16q.Distance-matched control',
            'Telomere - 16p.Distance-matched control'
        )
    ) %>% 
    make_nested_plot_tabs(
        group_cols=c('IF.Threshold'),
        max_header_lvl=4,
        plot_fnc=plot_contacts_regions_boxplot,
        bin_col='region.title',
        count_col='IF',
        color_col='region.color',
        facet_row='ReplicateNum',
        facet_col='Genotype',
        p.adjust.method='BH',
        p.max=0.05,
        tip.length=0,
        test_offset_y=3
    )
```
