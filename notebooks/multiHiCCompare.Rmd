---
title: "multiHiCCompare analysis of 16p samples"
author: "Siddharth Reed"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: true
        toc_float: true
        theme: paper
        code_folding: hide
        df_print: paged
---
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Set up

```{r knitr}
library(knitr)
knitr::opts_chunk$set(
    dev=c('png', 'pdf', 'svg'),
    dpi=300
)
```
Set up file locations + load dependenies
```{r file_locs, results=FALSE, message=FALSE, warning=FALSE}
library(here)
here::i_am('notebooks/matrix.QC.Rmd')
BASE_DIR <- here()
source(file.path(BASE_DIR, 'scripts/locations.R'))
source(file.path(SCRIPT_DIR, 'constants.R'))
source(file.path(SCRIPT_DIR, 'utils.data.R'))
source(file.path(SCRIPT_DIR, 'utils.plot.R'))
source(file.path(SCRIPT_DIR, 'utils.multiHiCCompare.R'))
library(tidyverse)
library(magrittr)
library(ggplot2)
library(ggh4x)
library(purrr)
```

# Generate + load all differential contact results

Set up all combinations of parameters and sample groups to test
```{r set_up_sample_comparisons}
# All combinations of analysis hyper-params 
hyper.params.df <- 
    expand_grid(
        # zero.p=c(0.6, 0.8),
        zero.p=c(0.8),
        A.min=c(5)
    )
# no covariates to control for
sample.metadata.df <- load_sample_metadata()
covariates.df <- 
    sample.metadata.df %>% 
    select(
        Sample.ID,
        Flowcell.ID
    ) %>%
    rename('Batch'=Flowcell.ID) %>% 
    mutate(Batch=as.factor(Batch))
# All pairs of sample groups to compare for differential contacts
comparisons.df <- 
    set_up_sample_comparisons() %>% 
    # ignore old iN samples
    filter(
        !grepl('.iN$', Sample.Group.A),
        !grepl('.iN$', Sample.Group.B)
    )
comparisons.df
```
For every group of samples + parameter combination run multiHiCCompare and cache the results.
```{r run_multihiccompare}
# GRanges object with Centro/Telomere regions to filter
data('hg38_cyto') 
# parallelizing params
library(BiocParallel)
numCores <- 32
register(MulticoreParam(workers=numCores), default=TRUE)
# Run multiHiCComapre on all comparisons
run_all_multiHiCCompare(    
    comparisons.df %>% arrange(isMerged),
    hyper.params.df,
    covariates.df,
    sample_group_priority_fnc=sample_group_priority_fnc_16p,
    force_redo=FALSE,
    remove.regions=hg38_cyto,
    p.method='fdr'
)
```

# Plot sgtuff

Prepare data for plotting
```{r}
plot_df <- 
    all.results %>% 
    mutate(logFC=-logFC) %>%
    mutate(log.p.adj=-log10(p.adj)) %>%
    left_join(load_chr_sizes(), by='Chr') %>% 
    rename(
        region1='region1.bp',
        region2='region2.bp'
    ) %>% 
    mutate(
        region1.bin=region1.bp / Resolution,
        region2.bin=region2.bp / Resolution,
        region1.pct=100 * (region1.bp / chr.total.bp),
        region2.pct=100 * (region2.bp / chr.total.bp)
    ) %>% 
    mutate(
        distance.bp=region2.bp - region1.bp,
        distance.kb=distance.bp / 1000,
        distance.bin=region2.bin - region1.bin,
        distance.pct=region2.pct - region1.pct
    ) %>%
    mutate(
        distance.discrete=
            case_when(
                distance.kb <= 5     ~  '    .< 5Kb',
                distance.kb <= 20    ~ ' 5Kb<.<20Kb',
                distance.kb <= 50    ~ '20Kb<.<50Kb',
                distance.kb <= 1000  ~ '50Kb<.< 1Mb',
                distance.kb <= 5000  ~ ' 1Mb<.<50Kb',
                distance.kb <= 30000 ~ ' 5Mb<.<30Kb',
                distance.kb >  30000 ~ '30Mb<.     ',
            ) %>%
            factor(levels=c('    .<  5Kb', ' 5Kb<.<20Kb', '20Kb<.<50Kb', '50Kb<.< 1Mb', ' 1Mb<.<50Kb', ' 5Mb<.<30Kb', '30Mb<.     '))
    ) %>% 
    mutate(
        Chr=factor(Chr, levels=c(paste0('chr', 1:22), 'chrX')),
        Resolution=fct_reorder(glue('{Resolution / 1000}Kb'), Resolution)
    )
plot_df %>% head(2) %>% t()
```
