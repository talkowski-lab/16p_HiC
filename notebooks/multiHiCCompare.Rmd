---
title: "multiHiCCompare analysis of 16p samples"
author: "Siddharth Reed"
date: "`r Sys.Date()`"
---
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Set up + Load all differential contact results

```{r knitr, eval=TRUE}
library(knitr)
knitr::opts_chunk$set(
    # eval=FALSE,
    warning=FALSE,
    message=FALSE,
    results=FALSE,
    # dev=c('png', 'pdf', 'svg'),
    dev=c('png', 'pdf'),
    # dev=c('pdf'),
    dpi=300
)
```
Set up file locations + load dependenies
```{r dependencies, eval=TRUE}
library(here)
here::i_am('notebooks/multiHiCCompare.Rmd')
BASE_DIR <- here()
source(file.path(BASE_DIR, 'scripts', 'locations.R'))
source(file.path(SCRIPT_DIR, 'utils.data.R'))
source(file.path(BASE_DIR, 'scripts', 'constants.R'))
source(file.path(SCRIPT_DIR, 'utils.plot.R'))
source(file.path(SCRIPT_DIR, 'DifferentialContacts', 'utils.multiHiCCompare.R'))
library(tidyverse)
library(magrittr)
```
re-usable plot elements
```{r plot_elements, eval=TRUE}
zero.lines <- 
    list(
        geom_hline(
            yintercept=0,
            linewidth=0.5,
            color='black',
            linetype='dashed'
        ),
        geom_vline(
            xintercept=0,
            linewidth=0.5,
            color='black',
            linetype='dashed'
        )
    )
```
Load results for all comparisons for all bin-pairs
```{r load_results, eval=TRUE}
plan(multisession, workers=availableCores())
differential.contacts.df <- 
    check_cached_results(
        results_file=MULTIHICCOMPARE_RESULTS_FILE,
        # force_redo=TRUE,
        results_fnc=load_all_multiHiCCompare_results,
        sample_group_priority_fnc=SAMPLE_GROUP_PRIORITY_FNC,
        sample.group.comparisons=ALL_SAMPLE_GROUP_COMPARISONS,
        resolutions=NULL,
        # gw.fdr.threshold=0.1,
        fdr.threshold=0.1,
        nom.threshold=0.05
    ) %>% 
    # filter(p.adj.gw < 0.1) %>% 
    # filter(resolution == 50000) %>% 
    filter(resolution != 5000) %>% 
    post_process_multiHiCCompare_results() %>% 
    standardize_data_cols()
plan(sequential)
```

# N Contacts {.tabset}

```{r n_contacts_plot_df}
n.plot.df <- 
    check_cached_results(
        results_file=MULTIHICCOMPARE_SIG_RESULTS_FILE,
        # force_redo=TRUE,
        results_fnc=count_contacts_by_significance
    ) %>% 
    inner_join(
        ALL_SAMPLE_GROUP_COMPARISONS,
        by=colnames(ALL_SAMPLE_GROUP_COMPARISONS)
    ) %>% 
   mutate(
        sig.lvl=
            factor(
                sig.lvl,
                levels=
                    c(
                        'N.S.',
                        'p.adj.gw < 0.1',
                        'p.adj.gw < 0.001',
                        'p.adj.gw < 1e-5',
                        'p.adj.gw < 1e-10',
                        'p.adj.gw < 1e-15'
                    )
            )
    ) %>% 
    filter(resolution == 50000) %>% 
    filter(sig.lvl != 'N.S.') %>% 
    standardize_data_cols()
```

## Genome-wide {.tabset}

```{r plot_n_DACs_gw, results='asis', fig.dim=c(8,4)}
n.plot.df %>% 
    group_by(
        # A.min, zero.p, merged,
        resolution, 
        Sample.Group, 
        Celltype,
        # chr,
        sig.lvl,
        name='nDACs'
    ) %>% 
    summarize(nDACs=sum(nDACs)) %>% 
    n_plot_fnc(
        group.cols=c('resolution'),
        x.var='sig.lvl',
        y.var='Sample.Group',
        facet.row='Celltype',
        axis.text.x=element_text(angle=45, hjust=1),
        label.size=5,
        scales='free_y'
    )
```

## Per Chr {.tabset}

```{r plot_n_DACs_chr, results='asis', fig.dim=c(9,6)}
n.plot.df %>% 
    filter(sig.lvl != 'N.S') %>% 
    n_plot_fnc(
        # group.cols=c('resolution', 'sig.lvl'),
        group.cols=c('resolution'),
        x.var='chr',
        # y.var='Sample.Group',
        # facet.row='sig.lvl',
        y.var='sig.lvl',
        facet.row='Sample.Group',
        label.size=2,
        strip.text=element_text(size=5),
        axis.text.x=element_text(angle=45, hjust=1)
    )
rm(n.plot.df)
```

# Distribution Plots {.tabset}

```{r dist_plot_df}
dist.plot.df <- 
    differential.contacts.df %>% 
    select(
        resolution,
        Celltype,
        Sample.Group,
        chr,
        # region1.bp, region2.bp, distance.bp,
         logFC, log.p.adj.gw
    ) %>%
    pivot_longer(
        c(logFC, log.p.adj.gw),
        names_to='statistic',
        values_to='value'
    )
```

## Genome-wide {.tabset}

```{r plot_fc_dist_gw, results='asis', fig.dim=c(9, 6)}
# dist.plot.df
dist.plot.df %>% 
    mutate(
        statistic=
            case_when(
                statistic == 'logFC'                     ~ '-log10(FC)',
                statistic == 'log.p.adj.gw' & value <  5 ~ '-log10(GW p adj) < 5',
                statistic == 'log.p.adj.gw' & value >= 5 ~ '-log10(GW p adj) > 5',
                TRUE                                     ~ NA
            ) %>%
            factor(
                levels=
                    c(
                        '-log10(GW p adj) > 5',
                        '-log10(GW p adj) < 5',
                        '-log10(FC)'
                    )
            )
    ) %>% 
    dist_plot_fnc(
        group.cols=c('resolution'),
        x.var='Sample.Group',
        fill.var='Sample.Group',
        facet.col='Celltype',
        scales='free',
        x.expand=c(0.1, 0.1, 0.1, 0.1),
        y.expand=c(0.1, 0.1, 0.1, 0.1),
        axis.text.x=element_text(angle=45, hjust=1, size=10),
        axis.text.y=element_text(size=15),
        strip.text=element_text(size=10)
        
    )
```

## Per Chr {.tabset}

```{r plot_fc_dist_chr, results='asis', fig.dim=c(16, 9)}
dist.plot.df %>% 
    # filter(resolution == '25Kb') %>% 
    dist_plot_fnc(
        group.cols=c('resolution', 'Celltype'),
        # group.cols=c('resolution'),
        x.var='chr',
        scales='free_y',
        # facet.col='Celltype'
        fill.var='Sample.Group',
        axis.text.x=element_text(angle=45, hjust=1, size=10),
        axis.text.y=element_text(size=15),
        strip.text=element_text(size=8),
        plot.elements=
            list(
                coord_cartesian(clip="off"),
                geom_hline(
                    yintercept=0,
                    linetype='dashed'
                )
            )
    )
```

# Volcano Plots {.tabset}

## Genome-Wide {.tabset}

```{r plot_volcanos_gw, results='asis', fig.dim=c(8, 4)}
differential.contacts.df %>% 
    volcano_plot_fnc(
        group.cols=c('resolution', 'Celltype'),
        color.var='Sample.Group', 
        size=1,
        # legend.position=c(0.7, 0.9)
        legend.position='right'
    )
```

## Fixed Scales {.tabset}

```{r plot_volcanos_fixed, results='asis', fig.dim=c(14, 8)}
differential.contacts.df %>% 
    volcano_plot_fnc(
        group.cols=c('resolution', 'Celltype'),
        color.var='Sample.Group', 
        facet.group='chr',
        facet.nrow=4
    )
```

## Free Scales {.tabset}

```{r plot_volcanos_free, results='asis', fig.dim=c(16, 8)}
differential.contacts.df %>% 
    volcano_plot_fnc(
        group.cols=c('resolution', 'Celltype'),
        color.var='Sample.Group', 
        facet.group='chr',
        facet.nrow=4,
        scales='free_y'
    )
```

# Distance Plots {.tabset}

```{r distance_plot_df}
distance.plot.df <- 
    differential.contacts.df %>% 
    mutate(
        distance.bracket=
            case_when(
                distance.bp > 150 * 1e6 ~ '> 100Mb',
                distance.bp >  50 * 1e6 ~ '>  50Mb',
                distance.bp >  20 * 1e6 ~ '>  20Mb',
                distance.bp >   5 * 1e6 ~ '>   5Mb',
                TRUE                    ~ '<=  5Mb'
            ) %>%
            factor(
                levels=
                    c(
                        '> 100Mb',
                        '>  50Mb',
                        '>  20Mb',
                        '>   5Mb',
                        '<=  5Mb'
                    )
            )
    ) %>% 
    select(
        resolution,
        Sample.Group, Celltype,
        chr, region1, region2, 
        distance.bp, distance.bracket,
        log.p.adj.gw, logFC
    ) #%>%
    # pivot_longer(
    #     c(logFC, log.p.adj.gw),
    #     names_to='statistic',
    #     values_to='value'
    # ) 
```

## Genome-Wide {.tabset}

```{r plot_distances_gw, results='asis', fig.dim=c(9, 6)}
distance.plot.df %>%
    distance_plot_fnc(
        group.cols=c('resolution', 'Celltype'),
        color.var='log.p.adj.gw', 
        facet.row='distance.bracket',
        facet.col='Sample.Group'
    )
```

## Per Chr {.tabset}

```{r plot_distances_chr, results='asis', fig.dim=c(14, 8)}
distance.plot.df %>%
    distance_plot_fnc(
        group.cols=c('resolution', 'Celltype'),
        legend.position='top',
        color.var='Sample.Group', 
        facet.group='chr',
        facet.ncol=6
    )
```

# Manhattan Plots {.tabset}

```{r manhattan_plot_df}
manhattan.plot.df <- 
    differential.contacts.df %>% 
    select(
        resolution, 
        Sample.Group, Celltype, 
        chr, 
        region1, region2, distance.bp,
        log.p.adj.gw, logFC
    ) %>%
    pivot_longer(
        c(region1, region2),
        names_to='contact.side',
        values_to='region.bp'
    ) %>% 
    mutate(
        contact.side=
            ifelse(
                contact.side == 'region1',
                'left',
                'right'
            )
    ) %>% 
    pivot_longer(
        c(logFC, log.p.adj.gw),
        names_to='statistic',
        values_to='value'
    ) 
```

## Faceted {.tabset}

```{r plot_manhattans_facet, results='asis', fig.dim=c(10, 6), eval=FALSE}
manhattan.plot.df %>% 
    manhattan_plot_fnc(
        # group.cols=c('Celltype', 'resolution', 'chr', 'statistic'),
        group.cols=c('resolution', 'Celltype', 'chr', 'statistic'),
        color.var='distance.bp', 
        facet.row='Sample.Group',
        legend.text=element_text(angle=45, hjust=1),
        strip.text=element_text(size=7),
        legend.position='top'
    )
```

## Color-wise {.tabset}

```{r plot_manhattans_color, results='asis', fig.dim=c(12, 6)}
manhattan.plot.df %>% 
    manhattan_plot_fnc(
        group.cols=c('resolution', 'Celltype', 'chr'),
        color.var='Sample.Group', 
        facet.row='statistic',
        legend.position='top',
        scales='free_y'
    )
```

# Common Hits Across Comparisons {.tabset}

Plot overlapping hits
```{r upset_plot_hits, results='asis', fig.dim=c(12, 7)}
# differential.contacts.df
# differential.contacts.df %>%
#     filter(Celltype == 'iN vs iN') %>% 
#     count(resolution, Sample.Group, chr)
# differential.contacts.df %>% count(resolution, Sample.Group)
differential.contacts.df %>% 
    filter(p.adj.gw < 0.1) %>% 
    select(
        resolution,
        Sample.Group,
        chr, bin.pair.idx
    ) %>% 
    make_nested_plot_tabs(
        plot.fnc=plot_upset,
        # group_cols=c('resolution', 'Group'),
        group.cols=c('resolution'),
        max.header.lvl=2,
        make.binary=TRUE,
        category_col='Sample.Group',
        title.str='Common DACs across Comparisons'
    )
```

# Pair Plots {.tabset}

Scatter plot of fold changes 
```{r plot_mhc_diagonals_ggpairs, results='asis', fig.dim=c(9, 9), eval=TRUE}
differential.contacts.df %>%
    # filter(p.adj.gw < 0.1) %>% 
    mutate(
        region=
            case_when(
                chr == 'chr16' & region1 <= 36800000 & region2 >= 36800000 ~ '16p-16q',
                chr == 'chr16' & region1 >= 36800000 & region2 <= 36800000 ~ '16p-16q',
                chr == 'chr16' & region1 <= 36800000 & region2 <= 36800000 ~ 'chr16p',
                chr == 'chr16' & region1 >= 36800000 & region1 >= 36800000 ~ 'chr16q',
                TRUE ~ 'Other'
            ) %>%
            factor(levels=c('chr16p', 'chr16q', 'Other'))
    ) %>% 
    select(
        resolution,
        Sample.Group, 
        chr, bin.pair.idx, region,
        distance.bp, 
        logFC, log.p.adj.gw
    ) %>% 
    pivot_longer(
        c(logFC, log.p.adj.gw),
        names_to='metric',
        values_to='value'
    ) %>% 
    mutate(Sample.Group=Sample.Group %>% str_remove_all('16p.') %>% str_replace_all(fixed('.'), ' ')) %>% 
    pivot_wider(
        names_from=Sample.Group,
        values_from=value
    ) %>% 
    # filter(Sample.Group != 'NSC WT vs iN WT') %>% 
    # mutate(is.chr16=ifelse(chr == 'chr16', chr, 'other')) %>% 
    make_nested_plot_tabs(
        group.cols=c('resolution', 'metric'),
        max.header.lvl=2,
        plot.fnc=
            function(freq.df, text.size=8){
                # print(grep(' vs ', colnames(freq.df), value=TRUE))
                # freq.df %>% print()
                # cols_to_plot=grep(' vs ', colnames(freq.df), value=TRUE)
                cols_to_plot=which(grepl(' vs ', colnames(freq.df)))
                # print(cols_to_plot)
                ggpairs(
                    freq.df,
                    mapping=aes(color=region, alpha=0.6),
                    columns=cols_to_plot
                ) +
                zero.lines[[1]] +
                zero.lines[[2]] +
                labs(
                    x='log(Fold-Change)',
                    y='log(Fold-Change)'
                ) +
                theme(
                    axis.text.x=element_text(size=text.size),
                    axis.text.y=element_text(size=text.size),
                    strip.text=element_text(size=text.size+1)
                ) + 
                make_ggtheme()
            }
    )
```

