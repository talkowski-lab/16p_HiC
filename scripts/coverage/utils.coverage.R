###################################################
# Dependencies
###################################################

###################################################
# Genome Marginal Coverage
###################################################
list_all_coverage_data <- function(resolutions=NULL){
    # List input files (generated by cooltools coverage)
    COVERAGE_DIR %>% 
    parse_results_filelist(
        suffix='-coverage.tsv',
        filename.column.name='MatrixID',
        param_delim='_'
    ) %>%
    # mutate(MatrixID=str_remove(MatrixID, file.suffix)) %>% 
    get_info_from_MatrixIDs(
        suffix=file.suffix,
        keep_id=FALSE
    ) %>% 
    # only keep specified resoltuions
    { 
        if (is.null(resolutions)) { 
            . 
        } else { 
            filter(., resolution %in% resolutions) 
        } 
    }
}

load_all_coverage_data <- function(resolutions=NULL){
    list_all_coverage_data(resolutions=resolutions) %>% 
    # Only need raw cis coverage
    filter(weight == 'raw') %>% 
    filter(count.type == 'cis') %>% 
    # load each coverage file and count % of bins > 0 and > 1000 contacts
    mutate(
        coverage.data=
            pmap(
                .l=.,
                .f=load_genome_coverage,
                .progress=TRUE
            )
    ) %>%
    unnest(coverage.data) %>%
    select(-c(filepath))
}

compute_summary_stats <- function(df){
    df %>% 
    summarize(
        coverage.min=min(coverage),
        coverage.q25=quantile(coverage, 0.25),
        coverage.median=median(coverage),
        coverage.mean=mean(coverage),
        coverage.q75=quantile(coverage, 0.75),
        coverage.max=max(coverage),
        coverage.total=sum(coverage),
        bins.n.total=n(),
        bins.n.nz=sum(coverage > 0),
        bins.n.covered=sum(coverage > 1000)
    ) %>%
    ungroup() %>%
    mutate(
        bins.pct.nz=bins.n.nz / bins.n.total,
        bins.pct.covered=bins.n.covered / bins.n.total
    )
}

compute_coverage_summary <- function(
    filepath,
    ...){
    # Load bin-wise Interaction Frequency data
    coverage.df <- 
        filepath %>%
        load_genome_coverage()
    # compute summary stats of IF across the entire genome
    genome.df <- 
        coverage.df %>% 
        group_by(metric) %>% 
        compute_summary_stats() %>% 
        add_column(chr='Genome.Wide')
    # compute summary stats of IF per chr
    chrs.df <- 
        coverage.df %>% 
        group_by(chr, metric) %>% 
        compute_summary_stats()
    # Bind + melt summaries
    bind_rows(
        chrs.df, 
        genome.df
    ) %>% 
    dplyr::rename('count.type'=metric) %>% 
    pivot_longer(
        matches('^(coverage|bins)\\.'),
        names_to='metric',
        values_to='value'
    )
}

compute_all_coverage_summaries <- function(resolutions=NULL){
    # List input files (generated by cooltools coverage)
    list_all_coverage_data(resolutions=resolutions) %>% 
    # Only need raw coverage
    filter(weight == 'raw') %>% 
    # load each coverage file and count % of bins > 0 and > 1000 contacts
    mutate(
        coverage.summary=
            pmap(
                .l=.,
                .f=compute_coverage_summary,
                .progress=TRUE
            )
    ) %>%
    unnest(coverage.summary) %>%
    get_info_from_MatrixIDs(keep_id=FALSE) %>% 
    filter(count.type == 'cis') %>% 
    select(-c(filepath))
}

