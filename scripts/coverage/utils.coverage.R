###################################################
# Dependencies
###################################################
# library(hictkR)

###################################################
# Genome Marginal Coverage
###################################################
list_all_coverage_data <- function(
    resolutions=NULL,
    file.suffix='-coverage.tsv'){
    # List input files (generated by cooltools coverage)
    COVERAGE_DIR %>% 
    parse_results_filelist(
        suffix=file.suffix,
        filename.column.name='MatrixID',
        param_delim='_'
    ) %>%
    get_info_from_MatrixIDs(
        suffix=file.suffix,
        keep_id=FALSE
    ) %>% 
    # only keep specified resoltuions
    { 
        if (is.null(resolutions)) { 
            . 
        } else { 
            filter(., resolution %in% resolutions) 
        } 
    }
}

load_coverage_data <- function(
    filepath,
    ...){
    filepath %>% 
    read_tsv(
        show_col_types=FALSE,
        progress=FALSE
    ) %>%
    dplyr::rename_with(~ str_remove(.x, '_(raw|weight)')) %>% 
    dplyr::rename(
        'chr'=chrom,
        'coverage.cis'=cov_cis,
        'coverage.total'=cov_tot,
    ) %>% 
    pivot_longer(
        starts_with('coverage'),
        names_to='metric',
        names_prefix='coverage.',
        values_to='coverage'
    )
}

load_all_coverage_data <- function(resolutions=NULL){
    list_all_coverage_data(resolutions=resolutions) %>% 
    # Only need raw cis coverage
    filter(weight == 'raw') %>% 
    filter(count.type == 'cis') %>% 
    # load each coverage file and count % of bins > 0 and > 1000 contacts
    mutate(
        coverage.data=
            pmap(
                .l=.,
                .f=load_coverage_data,
                .progress=TRUE
            )
    ) %>%
    unnest(coverage.data) %>%
    select(-c(filepath))
}

compute_summary_stats <- function(df){
    df %>% 
    summarize(
        coverage.min=min(coverage),
        coverage.q25=quantile(coverage, 0.25, na.rm=TRUE),
        coverage.median=median(coverage, na.rm=TRUE),
        coverage.mean=mean(coverage, na.rm=TRUE),
        coverage.q75=quantile(coverage, 0.75, na.rm=TRUE),
        coverage.max=max(coverage),
        coverage.total=sum(coverage, na.rm=TRUE),
        bins.n.total=n(),
        bins.n.detected=sum(!is.na(coverage)),
        bins.n.nz=sum(coverage > 0, na.rm=TRUE),
        bins.n.covered=sum(coverage > 1000, na.rm=TRUE)
    ) %>%
    ungroup() %>%
    mutate(
        bins.pct.nz=bins.n.nz / bins.n.total,
        bins.pct.covered=bins.n.covered / bins.n.total
    )
}

compute_coverage_summary <- function(
    filepath,
    ...){
    # Load bin-wise Interaction Frequency data
    coverage.df <- 
        filepath %>%
        load_coverage_data()
    # compute summary stats of IF across the entire genome
    genome.df <- 
        coverage.df %>% 
        group_by(metric) %>% 
        compute_summary_stats() %>% 
        add_column(chr='Genome.Wide')
    # compute summary stats of IF per chr
    chrs.df <- 
        coverage.df %>% 
        group_by(chr, metric) %>% 
        compute_summary_stats()
    # Bind + melt summaries
    bind_rows(
        chrs.df, 
        genome.df
    ) %>% 
    dplyr::rename('count.type'=metric) %>% 
    pivot_longer(
        matches('^(coverage|bins)\\.'),
        names_to='metric',
        values_to='value'
    )
}

compute_all_coverage_summaries <- function(resolutions=NULL){
    # List input files (generated by cooltools coverage)
    list_all_coverage_data(resolutions=resolutions) %>% 
    # load each coverage file and count % of bins > 0 and > 1000 contacts
    mutate(
        coverage.summary=
            pmap(
                .l=.,
                .f=compute_coverage_summary,
                .progress=TRUE
            )
    ) %>%
    unnest(coverage.summary) %>%
    select(-c(filepath))
}

post_process_coverage_summaries <- function(
    results.df,
    sample.metadata.df){
    results.df %>% 
    filter(
        ReadFilter == 'mapq_30',
        count.type == 'cis',
        weight == 'raw',
        # isGenome == 'Per.Chr',
        metric %in% c(
            'bins.n.covered',  
            'bins.n.detected', 
            'bins.n.nz',       
            'bins.n.total',    
            'bins.pct.covered',
            'bins.pct.nz',     
            'coverage.mean',   
            'coverage.median', 
            # 'coverage.min',    
            # 'coverage.q25',    
            # 'coverage.q75',    
            'coverage.total'
        )
    ) %>% 
    left_join(
        sample.metadata.df %>% select(SampleID, FlowcellID),
        by=join_by(SampleID)
    ) %>%
    mutate(FlowcellID=ifelse(is.na(FlowcellID), 'Merged', FlowcellID))
}

